"use strict";(self.webpackChunkbesom_website=self.webpackChunkbesom_website||[]).push([[680],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),l=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=l(e.components);return r.createElement(i.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,c=u(e,["components","mdxType","originalType","parentName"]),p=l(n),d=a,h=p["".concat(i,".").concat(d)]||p[d]||m[d]||o;return n?r.createElement(h,s(s({ref:t},c),{},{components:n})):r.createElement(h,s({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,s=new Array(o);s[0]=d;var u={};for(var i in t)hasOwnProperty.call(t,i)&&(u[i]=t[i]);u.originalType=e,u[p]="string"==typeof e?e:a,s[1]=u;for(var l=2;l<o;l++)s[l]=n[l];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5997:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>s,default:()=>m,frontMatter:()=>o,metadata:()=>u,toc:()=>l});var r=n(7462),a=(n(7294),n(3905));const o={title:"Laziness"},s=void 0,u={unversionedId:"laziness",id:"laziness",title:"Laziness",description:"Due to Besom's lazy semantics it's possible to declare resources in code and never actually execute that code.",source:"@site/docs/laziness.md",sourceDirName:".",slug:"/laziness",permalink:"/besom/docs/laziness",draft:!1,tags:[],version:"current",frontMatter:{title:"Laziness"},sidebar:"docsSidebar",previous:{title:"Resource constructors and asynchronicity",permalink:"/besom/docs/constructors"},next:{title:"Apply methods",permalink:"/besom/docs/apply_methods"}},i={},l=[],c={toc:l},p="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Due to Besom's ",(0,a.kt)("strong",{parentName:"p"},"lazy semantics")," it's possible to declare resources in code and never actually execute that code."),(0,a.kt)("p",null,"Let's expand on the ",(0,a.kt)("inlineCode",{parentName:"p"},"s3Bucket")," example used in the ",(0,a.kt)("a",{parentName:"p",href:"/besom/docs/exports"},"Exports")," section:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-scala"},'import besom.*\nimport besom.api.aws\n\n@main def main = Pulumi.run {\n  val s3Bucket: Output[aws.s3.Bucket] = aws.s3.Bucket("my-bucket")\n  \n  Output(Pulumi.exports())\n}\n')),(0,a.kt)("p",null,"In this case the ",(0,a.kt)("inlineCode",{parentName:"p"},"s3Bucket")," is only declared, but it's not composed into the main flow of the program\n(it's never ",(0,a.kt)("em",{parentName:"p"},"mapped")," or ",(0,a.kt)("em",{parentName:"p"},"flatMapped"),") so if you were to run ",(0,a.kt)("inlineCode",{parentName:"p"},"pulumi up")," you'd see no resources in the deployment plan. "),(0,a.kt)("p",null,"There are two ways to avoid this:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"1.")," if your infrastructure just depends on the resource being present, and you never use any of the properties that\nare the Outputs of that resource you should manually compose it so that the resource constructor is evaluated:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-scala"},'import besom.*\nimport besom.api.aws\n\n@main def main = Pulumi.run {\n  val s3Bucket: Output[aws.s3.Bucket] = aws.s3.Bucket("my-bucket")\n\n  for \n    _ <- s3Bucket\n  yield Pulumi.exports() \n  \n  // or just s3Bucket.map(_ => Pulumi.exports())\n}\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"2.")," if your infrastructure or exports mention that resource or any of its properties Besom will implicitly pull\nit into the main flow of the program and evaluate it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-scala"},'import besom.*\nimport besom.api.aws\n\n@main def main = Pulumi.run {\n  val s3Bucket: Output[aws.s3.Bucket] = aws.s3.Bucket("my-bucket")\n\n  Output(Pulumi.exports(s3Url = s3Bucket.map(_.websiteEndpoint)))\n}\n')),(0,a.kt)("p",null,"This will also work if you pass any of the Outputs of any resource as inputs to another resource's constructor."),(0,a.kt)("p",null,"To help you avoid mistakes with dangling resources that never get evaluated we are working on a feature that will warn\nyou during dry run phase that there were resource constructor calls encountered during the evaluation of your program\nthat were never composed back into the main flow of the Besom program.\nMeanwhile, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"-Wunused:all")," compiler flag."),(0,a.kt)("p",null,"There's also one more property of Besom's resource constructors that needs a mention here. Pure, functional programs are\nexpected to ",(0,a.kt)("strong",{parentName:"p"},"execute side effects")," as many times as they are executed. "),(0,a.kt)("p",null,"Let's see this on an example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-scala"},'import besom.*\nimport besom.api.aws\n\n@main def main = Pulumi.run {\n  val s3Bucket: Output[aws.s3.Bucket] = aws.s3.Bucket("my-bucket")\n  val launchMissiles: Output[_] = Output { launch() }\n  \n  for \n    _ <- s3Bucket\n    _ <- s3Bucket    \n    _ <- launchMissiles\n    _ <- launchMissiles\n  yield Pulumi.exports() \n}\n')),(0,a.kt)("p",null,"If we were to apply that understanding here we would expect that this program would create the S3 bucket twice\nand launch the missiles twice. This isn't true because resource ",(0,a.kt)("strong",{parentName:"p"},"constructors are ",(0,a.kt)("a",{parentName:"strong",href:"https://en.wikipedia.org/wiki/Memoization"},"memoized")),". "),(0,a.kt)("p",null,"Pulumi enforces a strict invariant according to which any given ",(0,a.kt)("strong",{parentName:"p"},"resource can be declared only once"),".\nTo deal with it all the calls to a resource constructor with the same arguments are cached and return the same resource\nafter the first call. Plain ",(0,a.kt)("strong",{parentName:"p"},"Outputs on the other hand have no such property")," so this program would create the S3 bucket\nonce but launch the missiles twice!"),(0,a.kt)("p",null,"To summarise, if you want to avoid surprises with dangling resources you should always compose\nresource constructors into the main flow of your program and avoid using plain Outputs for side effects."))}m.isMDXComponent=!0}}]);