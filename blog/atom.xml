<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://virtuslab.github.io/besom/blog/</id>
    <title>Besom, Scala SDK for Pulumi blog</title>
    <updated>2024-03-01T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://virtuslab.github.io/besom/blog/"/>
    <subtitle>Besom - Pulumi Scala Blog</subtitle>
    <icon>https://virtuslab.github.io/besom/img/favicon.ico</icon>
    <rights>Copyright © 2025 VirtusLab Sp. z o.o.</rights>
    <entry>
        <title type="html"><![CDATA[Shipping your code to cloud with Scala, Besom and Pulumi]]></title>
        <id>https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/</id>
        <link href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/"/>
        <updated>2024-03-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Besom, the Scala SDK for Pulumi, has just had it's second release - the 0.2.x series - that focuses on improving the developer experience based on the feedback from early adopters. This release is also the first release marking our march towards the stability of the APIs crafted with awesome developer experience in mind. Before getting into new features and changes let's step back a bit and discuss what Besom really is and why we've built it.]]></summary>
        <content type="html"><![CDATA[<p>Besom, the Scala SDK for Pulumi, has just had it's second release - the <a href="https://virtuslab.github.io/besom/docs/changelog#020-08-02-2024" target="_blank" rel="noopener noreferrer">0.2.x</a> series - that focuses on improving the developer experience based on the feedback from early adopters. This release is also the first release marking our march towards the stability of the APIs crafted with awesome developer experience in mind. Before getting into new features and changes let's step back a bit and discuss what Besom really is and why we've built it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-wider-perspective">A wider perspective<a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#a-wider-perspective" class="hash-link" aria-label="Direct link to A wider perspective" title="Direct link to A wider perspective" translate="no">​</a></h3>
<p>Current landscape of software engineering is different in comparison to what it was just a decade ago when Terraform launched but even then the trend towards programmatic management of not only business problems but also software and hardware operations was clearly visible. The space itself was dominated by fragile bash scripting and configuration management DSLs that required additional learning and provided little elasticity. The complexity of software itself grew however as Internet grew ever bigger. It is therefore our opinion that software engineering will evolve to incorporate platform engineering as a first-class citizen - not as a thing that a remote operations teams does but as a natural part of application lifecycle that every developer can easily work with. This merge is already happening with new emergent technologies like <a href="https://klo.dev/" target="_blank" rel="noopener noreferrer">Klotho</a> and <a href="https://nitric.io/" target="_blank" rel="noopener noreferrer">Nitric</a> but what is first necessary for proliferation of this approach is the common fundamental abstraction of platform resources.</p>
<p>We believe that <a href="https://pulumi.com/" target="_blank" rel="noopener noreferrer">Pulumi</a> is the solution for Infrastructure as Software (IaS) - a tool like Terraform but much more elastic, much more accessible, composable and developer-friendly. Pulumi can be used from any language that offers a SDK and that's how it marries the ops with the dev - you use the tool that you use to declare resources your application will use and execute on. In the same vein of modern requirements in IT - scalability, robustness, reliability and performance - Scala is a proven contender that keeps evolving to meet new demands. We've felt that the next frontier the scalable language can manage is the domain of platform engineering. For this reason we have joined our forces with Pulumi to first bring Pulumi to JVM with the <a href="https://github.com/pulumi/pulumi-java" target="_blank" rel="noopener noreferrer">Java SDK</a> and then, based on that experience, built <a href="https://github.com/VirtusLab/besom" target="_blank" rel="noopener noreferrer">Besom, the Scala SDK for Pulumi</a>. Besom is therefore a way to declare and manage infrastructural resources in an idiomatic, functional way using Scala.</p>
<p>I am, personally, of the opinion that code is worth a million words so the best way to show you how easy reliable<sup><a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#user-content-fn-1-ced4a1" id="user-content-fnref-1-ced4a1" data-footnote-ref="true" aria-describedby="footnote-label" class="footnoteRefStickyNavbar_i6ta">1</a></sup> cloud engineering becomes with Besom is to just write some code! Quite often what you want to do is to just run your small app somewhere. Let's assume, for the sake of example, that "somewhere" is the Google Cloud Platform's Cloud Run service which is a managed runtime for containerised applications.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-app">The App<a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#the-app" class="hash-link" aria-label="Direct link to The App" title="Direct link to The App" translate="no">​</a></h3>
<p>Let's start with a small web app. To keep things as simple as possible we'll use <a href="https://scala-cli.virtuslab.org/" target="_blank" rel="noopener noreferrer">scala-cli</a> which will take care of packaging our application for us. We'll also use <a href="https://tapir.softwaremill.com/en/latest/server/jdkhttp.html" target="_blank" rel="noopener noreferrer">tapir's</a> JDK HTTP server support and leverage Loom because it's just free performance. Let's create a directory for the whole project somewhere and then put our app in <code>./app</code> subdirectory. The <code>project.scala</code> file will look like this:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//&gt; using scala 3.3.3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using options -Werror -Wunused:all -Wvalue-discard -Wnonunit-statement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using jvm "graalvm-java21:21.0.2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using dep com.softwaremill.sttp.tapir::tapir-jdkhttp-server:1.9.10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using dep com.softwaremill.sttp.tapir::tapir-files:1.9.10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using dep com.outr::scribe:3.13.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using publish.organization org.virtuslab.besom.example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using publish.name app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//&gt; using resourceDir resources</span><br></span></code></pre></div></div>
<p>The <code>scala-cli</code> directives are pretty self-explanatory:</p>
<ul>
<li>we use Scala 3.3.3 LTS</li>
<li>we add some linting options for the compiler</li>
<li>we select GraalVM CE for JDK 21 as the runtime (because of Loom and because GraalVM is awesome)</li>
<li>we also pull some dependencies - tapir for http server along with static file serving module and scribe for logging</li>
<li>we name the project for publishing</li>
<li>and finally we designate a directory that will contain our resources</li>
</ul>
<p>The whole app fits in a single file - two endpoints, a HTML snippet as string and a http server definition:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">org</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">virtuslab</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">besom</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sttp</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">tapir</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sttp</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">tapir</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">server</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">jdkhttp</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sttp</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">tapir</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">files</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">java</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">util</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">concurrent</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">Executors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sttp</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">model</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">HeaderNames</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@main</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Unit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// required by Cloud Run Container runtime contract</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// https://cloud.google.com/run/docs/reference/container-contract</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.0.0.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"PORT"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flatMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toIntOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8080</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// handle index path only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> indexEndpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> endpoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extractFromRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connectionInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remote</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HeaderNames</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">XForwardedFor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">htmlBodyUtf8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handle </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestHost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> remote </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> xff</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getOrElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"unknown"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> forwarded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> xff</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isDefined then </span><span class="token string" style="color:#e3116c">"forwarded"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"not forwarded"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scribe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">"Received request from </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">remote</span><span class="token string-interpolation string" style="color:#e3116c"> (</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">forwarded</span><span class="token string-interpolation string" style="color:#e3116c">) serving index.html..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Right</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// serve resources in "static" directory under static/ path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> staticResourcesEndpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    staticResourcesGetServerEndpoint</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"static"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// use classloader used to load this application</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      classOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">type</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getClassLoader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"static"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scribe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">"Starting server on </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">host</span><span class="token string-interpolation string" style="color:#e3116c">:</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">$</span><span class="token string-interpolation interpolation expression">port</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JdkHttpServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// use Loom's virtual threads to dispatch requests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">executor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Executors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">newVirtualThreadPerTaskExecutor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">port</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">staticResourcesEndpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addEndpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexEndpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// html template using tailwind css</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  &lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  &lt;html lang="en"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;meta charset="UTF-8"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;title&gt;Scala 3 app!&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;div class="flex h-screen w-full justify-center items-center"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">      &lt;img src="static/scala.png" alt="scala logo"/&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  &lt;/html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">  """</span><br></span></code></pre></div></div>
<p>It doesn't do much as you can see as it only solves the hardest problem in web development using tailwind and displays Scala logo centered horizontally and vertically.</p>
<p>We can check if tailwind did a good job by simply executing one command in the directory storing both files and navigating to <code>localhost:8080</code> in browser.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">scala-cli run app</span><br></span></code></pre></div></div>
<p>If you don't have <code>scala-cli</code> on your machine already it is super <a href="https://scala-cli.virtuslab.org/install/" target="_blank" rel="noopener noreferrer">easy to fix</a>, e.g.:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sSLf https://scala-cli.virtuslab.org/get | sh</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="run-app-run">Run App, Run!<a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#run-app-run" class="hash-link" aria-label="Direct link to Run App, Run!" title="Direct link to Run App, Run!" translate="no">​</a></h3>
<p>We have our app and now we need to deploy it "somewhere" using Besom. To <a href="https://virtuslab.github.io/besom/docs/getting_started" target="_blank" rel="noopener noreferrer">get started</a> we need to install Pulumi:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -fsSL https://get.pulumi.com/ | sh</span><br></span></code></pre></div></div>
<p>and then install Scala language plugin for Pulumi:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pulumi plugin install language scala 0.2.2 --server github://api.github.com/VirtusLab/besom</span><br></span></code></pre></div></div>
<p>Having done that we can initialise a new project:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir infra &amp;&amp; cd infra</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pulumi new https://github.com/VirtusLab/besom/tree/v0.2.2/templates/gcp</span><br></span></code></pre></div></div>
<p>This will launch project builder, ask us some basic questions about how the project will be called, how the initial stack will be called and also what password should be used to encrypt the secrets<sup><a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#user-content-fn-2-ced4a1" id="user-content-fnref-2-ced4a1" data-footnote-ref="true" aria-describedby="footnote-label" class="footnoteRefStickyNavbar_i6ta">2</a></sup>. We end up with 4 files inside of <code>./infra</code> directory:</p>
<ul>
<li><code>Main.scala</code> which contains our infrastructure as Scala code</li>
<li><code>project.scala</code> which contains <code>scala-cli</code> directives</li>
<li><code>Pulumi.yaml</code> which contains public settings of the project</li>
<li><code>Pulumi.$STACK.yaml</code> which contains the secrets bound to particular stack where <code>$STACK</code> is the name we have provided in the previous step</li>
</ul>
<p>To start we will need to add docker support for besom so that we can push our application's image to Google Container Registry (GCR). To do that we need to put these lines into <code>project.scala</code>:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//&gt; using dep "org.virtuslab::besom-docker:4.5.3-core.0.3"</span><br></span></code></pre></div></div>
<p>Since we want Besom to manage our image building we won't be able to benefit from <code>scala-cli</code>'s built-in Docker packaging capabilities but that's actually fine because we would like our Cloud Run app to have the smallest possible footprint possible. To do that we will need to leverage another application packaging capability of <code>scala-cli</code> - that of GraalVM native-image building. Besom's Docker integration expects us to provide a <code>Dockerfile</code> that will describe how to create the image and that's exactly what we're going to do by putting this content into <code>./app/Dockerfile</code>:</p>
<div class="language-Dockerfile language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM --platform=linux/amd64 debian:stable-slim AS build-env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARG DEBIAN_FRONTEND=noninteractive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN --mount=type=cache,target=/var/cache/apt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apt-get update  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; apt-get install -y curl gzip build-essential libz-dev zlib1g-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Install Scala CLI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARG SCALA_CLI_VERSION=1.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl -sSLf https://github.com/VirtusLab/scala-cli/releases/download/v${SCALA_CLI_VERSION}/scala-cli-x86_64-pc-linux.gz | gunzip -c &gt; /usr/local/bin/scala-cli  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; chmod +x /usr/local/bin/scala-cli  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;&amp; /usr/local/bin/scala-cli version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM --platform=linux/amd64 build-env AS build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy local code to the container image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY . .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Build a native binary with Scala CLI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARG GRAALVM_VERSION=21.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --mount=type=cache,target=/root/.cache/coursier \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /usr/local/bin/scala-cli --power package . \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --suppress-experimental-feature-warning \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --server=false \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --jvm=graalvm-java21:${GRAALVM_VERSION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --native-image \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --graalvm-jvm-id=graalvm-java21:${GRAALVM_VERSION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --graalvm-args="--static" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --graalvm-args="--install-exit-handlers" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --graalvm-args="--no-fallback" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --graalvm-args="-H:IncludeResources=.*png" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --main-class org.virtuslab.besom.example.main -o app -f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM --platform=linux/amd64 gcr.io/distroless/static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy the binary to the production image from the builder stage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY --from=build /src/app /bin/app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Run the web service on container startup.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD ["/bin/app"]</span><br></span></code></pre></div></div>
<p>This multi-stage <code>Dockerfile</code> will yield a very small final (34.4 MB!) image that will contain only the binary of our app. It also takes care of cross-compilation if necessary.</p>
<p>With this set up we can finally write down infrastructure necessary to deploy our service. Let's clear out our main function's body and start with some basic definitions:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@main</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> main </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Pulumi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> project </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requireString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gcp:project"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> region  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requireString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gcp:region"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> repoName      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation id function" style="color:#d73a49">p</span><span class="token string-interpolation string" style="color:#e3116c">"gcr.io/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">project</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">pulumiProject</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// will be automatically created by GCP on docker push</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> appName       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"app"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> imageFullName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation id function" style="color:#d73a49">p</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">repoName</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">appName</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">:latest"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dockerImage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imageFullName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>First we declare that our program needs some values from configuration regarding the GCP project ID and the region to which we want to deploy to. Configuration will be returned as <code>Output[String]</code> values which are roughly equal to <code>IO[String]</code> (or <code>Task[String]</code> if you prefer ZIO)  but we need to interpolate that information to build the image name for GCR. Usually that would involve writing something akin to:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> imageFullName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> proj </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> repoName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">"gcr.io/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">proj</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">pulumiProject</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> appName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"app"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">repoName</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">appName</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">:latest"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">    </span><br></span></code></pre></div></div>
<p>but Besom offers a <code>p""</code> / <code>pulumi""</code> string interpolator that simplifies this a lot and returns <code>Output[String]</code> for us.</p>
<p>Google Cloud Platform requires us to enable services that we wish to use and therefore the first Besom resource that we have to create will be <code>gcp.projects.Service</code> that allows us to manage service configuration for the project. We will future-proof it a bit with a small enum and make a small, helpful wrapper for the capabilities that we need:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> GoogleApis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> CloudRun </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> GoogleApis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"run.googleapis.com"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> enableApiKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> NonEmptyString </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation id function" style="color:#d73a49">s</span><span class="token string-interpolation string" style="color:#e3116c">"enable-</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">name</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation expression">replace</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation expression string" style="color:#e3116c">"."</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">,</span><span class="token string-interpolation interpolation expression"> </span><span class="token string-interpolation interpolation expression string" style="color:#e3116c">"-"</span><span class="token string-interpolation interpolation expression punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Enable GCP service(s) for the current project</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> enableServices</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">GoogleApis</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GoogleApis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CloudRun</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    api </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enableApiKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        project </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* if true - at every destroy this will disable the dependent services for the whole project */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disableDependentServices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* if true - at every destroy this will disable the service for the whole project */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disableOnDestroy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toMap</span><br></span></code></pre></div></div>
<p>For these services to be configured (there's just one for now) we have to make the Stack aware of the necessity their evaluation. We modify the result of our main function then:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Stack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sequence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">enableServices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dockerImage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imageFullName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>With this change we can run our Besom project using <code>pulumi up</code> in <code>./infra</code> directory and Pulumi will be able to enable Cloud Run service for us.</p>
<p>Next step is for Besom to build and push our Docker image for us. This bit is quite straightforwards - we only need to introduce a new import on the top of the file:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">besom</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">api</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">docker</span><br></span></code></pre></div></div>
<p>and then declare a <code>docker.Image</code> resource like this:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Build a Docker image from our Scala app and push it to GCR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Image</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"image"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    docker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ImageArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      imageName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imageFullName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      build </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> docker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DockerBuildArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation id function" style="color:#d73a49">p</span><span class="token string-interpolation string" style="color:#e3116c">"../</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">${</span><span class="token string-interpolation interpolation expression">appName</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        platform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"linux/amd64"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Cloud Run only supports linux/amd64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>We provide a full name of the image that we've constructed before, the path to Docker context - our <code>Dockerfile</code> in <code>./app</code> folder and the platform for which we want the image to be built for.</p>
<p>Next step is to deploy a Cloud Run service:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> service </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"service"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      location </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> region</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> appName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      template </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceTemplateArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceTemplateSpecArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          containers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceTemplateSpecContainerArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imageName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceTemplateSpecContainerResourcesArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              limits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"memory"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1Gi"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> Nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    opts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dependsOn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> enableServices</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GoogleApis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CloudRun</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This is a bit more involved as there are more properties to configure:</p>
<ul>
<li>we pass information about the region in which this deployment should happen in</li>
<li>we set up the name of the Cloud Run service - <code>app</code></li>
<li>we then specify that we want to use our container with 1 GB of RAM</li>
</ul>
<p>One important thing here is that we pass a resource option declaring that this resource has to be created only after Cloud Run service is enabled. Pulumi is parallel by default not to choke on relatively slow cloud provider APIs and therefore some sequential relationships between resources require a manual setup of the dependency in the evaluation graph. This is not necessary when an output value of one resource is used as an input for another but in this case we have to give Pulumi a small hint.</p>
<p>Finally, we have to inform GCP that we want anyone to be able to reach our application from the internet by configuring an IAM member resource:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Open the service to public unrestricted access</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> serviceIam </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IamMember</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"service-iam-everyone"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloudrun</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IamMemberArgs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      location </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">location</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      role </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"roles/run.invoker"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      member </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"allUsers"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>The last thing to do is to add the URL of our app to Stack's exports and add the IAM member to dependencies of our Stack:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Stack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sequence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">enableServices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceIam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dockerImage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> imageFullName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Export the DNS name of the service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">statuses</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">headOption</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>After this step we can run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pulumi up</span><br></span></code></pre></div></div>
<p>in our <code>./infra</code> directory and let Pulumi handle all the heavy lifting. After a while we will see an output:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Please choose a stack, or create a new one: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Previewing update (dev):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Type                       Name                       Plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   pulumi:pulumi:Stack        gcp-cloudrun-dev           create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   ├─ gcp:projects:Service    enable-run-googleapis-com  create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   ├─ docker:index:Image      image                      create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   ├─ gcp:cloudrun:Service    service                    create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   └─ gcp:cloudrun:IamMember  service-iam-everyone       create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Outputs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dockerImage: "gcr.io/redacted-redacted/gcp-cloudrun/app:latest"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceUrl : output&lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    + 5 to create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you want to perform this update? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Updating (dev):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Type                       Name                       Status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   pulumi:pulumi:Stack        gcp-cloudrun-dev           created (276s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   ├─ gcp:projects:Service    enable-run-googleapis-com  created (4s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   ├─ docker:index:Image      image                      created (166s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   ├─ gcp:cloudrun:Service    service                    created (109s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +   └─ gcp:cloudrun:IamMember  service-iam-everyone       created (4s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Outputs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dockerImage: "gcr.io/redacted-redacted/gcp-cloudrun/app:latest"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceUrl : "https://app-kdthccbreq-lm.a.run.app"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    + 5 created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration: 4m44s</span><br></span></code></pre></div></div>
<p>We can now copy the output of <code>serviceUrl</code> property to the browser and enjoy our new app being live!</p>
<p>Cloud Run offers some nice observability features from the start so let's generate some traffic to see that everything is about right:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wrk -t5 -c25 -d120s https://app-kdthccbreq-lm.a.run.app</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Running 2m test @ https://app-kdthccbreq-lm.a.run.app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5 threads and 25 connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Latency    17.68ms   10.49ms 455.92ms   98.89%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Req/Sec   284.36     38.99   350.00     92.98%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  165617 requests in 2.00m, 112.77MB read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Socket errors: connect 0, read 0, write 0, timeout 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Requests/sec:   1379.24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer/sec:      0.94MB</span><br></span></code></pre></div></div>
<p>And that's how it looks in the GCP Console:</p>
<p><img decoding="async" loading="lazy" alt="metrics" src="https://virtuslab.github.io/besom/assets/images/metrics-9c9a8c6dc492080260d463952b8d7730.png" width="3354" height="1506" class="img_ev3q"></p>
<p>To clean up we can simply run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pulumi destroy</span><br></span></code></pre></div></div>
<p>and all resources registered with the stack will be removed:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Please choose a stack: dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Previewing destroy (dev):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Type                       Name                       Plan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   pulumi:pulumi:Stack        gcp-cloudrun-dev           delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   ├─ gcp:cloudrun:IamMember  service-iam-everyone       delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   ├─ gcp:cloudrun:Service    service                    delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   ├─ gcp:projects:Service    enable-run-googleapis-com  delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   └─ docker:index:Image      image                      delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Outputs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - dockerImage: "gcr.io/besom-413811/gcp-cloudrun/app:latest"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - serviceUrl : "https://app-kdthccbreq-lm.a.run.app"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 5 to delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you want to perform this update? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destroying (dev):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Type                       Name                       Status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   pulumi:pulumi:Stack        gcp-cloudrun-dev           deleted (0.00s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   ├─ gcp:cloudrun:IamMember  service-iam-everyone       deleted (5s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   ├─ gcp:cloudrun:Service    service                    deleted (0.13s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   ├─ gcp:projects:Service    enable-run-googleapis-com  deleted (12s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -   └─ docker:index:Image      image                      deleted (0.00s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Outputs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - dockerImage: "gcr.io/besom-413811/gcp-cloudrun/app:latest"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - serviceUrl : "https://app-kdthccbreq-lm.a.run.app"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 5 deleted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration: 19s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The resources in the stack have been deleted, but the history and configuration associated with the stack are still maintained.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If you want to remove the stack completely, run `pulumi stack rm dev`.</span><br></span></code></pre></div></div>
<p>Fun part about this is that it's just as easy to set things up using any other cloud provider, even the smaller and less popular ones. Besom's provider library includes all (since 0.2.0) publicly available <a href="https://www.pulumi.com/registry/" target="_blank" rel="noopener noreferrer">Pulumi providers</a> and <a href="https://central.sonatype.com/search?q=besom&amp;sort=published" target="_blank" rel="noopener noreferrer">counts around 150 integrations</a> at the moment.</p>
<p>The full code for this app can be found <a href="https://github.com/VirtusLab/besom-scala-on-cloudrun" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>This sample application has been adapted from our library of examples available <a href="https://github.com/VirtusLab/besom/tree/release/v0.2.2/examples" target="_blank" rel="noopener noreferrer">here</a> - we invite you to check out others as well. While waiting anxiously to see what you build with Besom we'll keep ourselves busy improving the developer experience even further and delivering the <a href="https://www.pulumi.com/automation/" target="_blank" rel="noopener noreferrer">Automation API</a>.</p>
<!-- -->
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_LWe7 sr-only" id="footnote-label">Footnotes<a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes" translate="no">​</a></h2>
<ol>
<li id="user-content-fn-1-ced4a1">
<p>I know you can just set things up in the console of your cloud provider but common experience proves that this approach works for about a week or month and then the decay sets in and after a while someone deletes prod by accident <a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#user-content-fnref-1-ced4a1" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-2-ced4a1">
<p><strong>important</strong>, always provide a good password here, it's used to encrypt secrets so that you can store them in your git repo <a href="https://virtuslab.github.io/besom/blog/2024/03/01/0.2.x-release/#user-content-fnref-2-ced4a1" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section>]]></content>
        <author>
            <name>Łukasz Biały</name>
            <email>lbialy@virtuslab.com</email>
            <uri>https://x.com/lukasz_bialy</uri>
        </author>
    </entry>
</feed>