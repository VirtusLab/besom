package yaga.sbt.aws

import sbt._
import sbt.Keys._

import sbt.AutoPlugin

import java.nio.file.{Files, Path}

object YagaAwsCodeGenPlugin extends AutoPlugin {
  val pluginVersion = "0.4.0-SNAPSHOT"
  val yagaAwsSdkDep = "org.virtuslab" %% "yaga-sdk-aws" % pluginVersion
  val yagaBesomAwsSdkDep = "org.virtuslab" %% "yaga-besom-sdk-aws" % pluginVersion

  object autoImport {
    val yagaAwsCodegenItems: TaskKey[Seq[CodegenItem]] = taskKey[Seq[CodegenItem]]("Configuration entries for Yaga AWS codegen") // TODO when referring to the setting use a narrower scope (e.g. Compile)?
    val yagaAwsGenerate: TaskKey[Seq[File]] = taskKey[Seq[File]]("Generate code for yaga AWS")

    // TODO
    // val yagaAwsAutoDependencies: SettingKey[Seq[ModuleID]] = settingKey[Seq[ModuleID]]("Automatically added library dependencies required by code generated by yaga AWS codegen")
  }

  import autoImport._

  override def projectSettings: Seq[Setting[_]] = Seq(
    yagaAwsGenerate := helperGenerator.map(_.flatten).value,

    Compile / sourceGenerators += helperGenerator.map(_.flatten).taskValue,
  )

  private def flattenTasks[A](tasks: Seq[Def.Initialize[Task[A]]]): Def.Initialize[Task[List[A]]] =
    tasks.toList match {
      case Nil => Def.task { Nil }
      case x :: xs => Def.taskDyn { flattenTasks(xs) map (x.value :: _) }
  }

  private def undefinedKeyError[A](key: AttributeKey[A]): A = {
    sys.error(s"Please declare a value for the `${key.label}` key. " +
      s"Description: '${key.description.getOrElse("A required key")}'"
    )
  }

  private def codegenResultPathsFromSummaryFile(file: File): Seq[File] = {
    val lines = scala.io.Source.fromFile(file).getLines
    lines.map(new File(_)).toList
  }

  private def runCodegen(localJarSources: Seq[Path], packagePrefix: String, outputDir: Path, summaryFile: Path, withInfra: Boolean): Seq[File] = {
    val mainArgs = codegenMainArgs(localJarSources, packagePrefix, outputDir, summaryFile, withInfra)

    MavenArtifactsHelpers.runMavenArtifactMainWithArgs(
      "org.virtuslab", "yaga-codegen-aws_3", "0.4.0-SNAPSHOT",
      "yaga.codegen.aws.runCodegen",
      mainArgs
    )

    codegenResultPathsFromSummaryFile(summaryFile.toFile)
  }

  private def codegenMainArgs(localJarSources: Seq[Path], packagePrefix: String, outputDir: Path, summaryFile: Path, withInfra: Boolean): Seq[String] = {
    val infraMainArgs =
      if (withInfra)
        Seq("--with-infra")
      else
        Seq.empty

    val sourcesOptions = localJarSources.flatMap(path => Seq("--local-jar", path.toString))

    val mainArgs = sourcesOptions ++ Seq(
      "--package-prefix", packagePrefix,
      "--output-dir", outputDir.toString,
      "--summary-file", summaryFile.toString,
    ) ++ infraMainArgs
    mainArgs
  }

  private def helperGenerator: Def.Initialize[Task[List[Seq[File]]]] = Def.taskDyn {
    val items = yagaAwsCodegenItems.value

    val subtasks: Seq[Def.Initialize[Task[Seq[File]]]] = items.map { case item =>
      val outputSubdirName = item match {
        case item: CodegenItem.FromMaven => item.outputSubdirName
        case item: CodegenItem.FromLocalJars => item.outputSubdirName
        // case item: CodegenItem.FromProject => item.project.project // TODO
      }

      val codegenOutputDir = (Compile / sourceManaged).value / "yaga-aws-codegen" / outputSubdirName
      val summaryFile = Files.createTempFile("codegen-summary-", ".txt")
      val sources: Seq[Path] = item match {
        case item: CodegenItem.FromMaven =>
          val List(orgName, moduleName, version) = item.artifactCoordinates.split(":").toList
          val jarPath = MavenArtifactsHelpers.fatJarPathFromMavenCoordinates(orgName = orgName, moduleName = moduleName, version = version).toAbsolutePath
          Seq(jarPath)

        case item: CodegenItem.FromLocalJars =>
          item.absoluteJarsPaths

        // TODO
        // case item: CodegenItem.FromProject =>
      }

      val packagePrefix = item.packagePrefix
      val withInfra = item.withInfra

      Def.task {
        runCodegen(localJarSources = sources, packagePrefix = packagePrefix, outputDir = codegenOutputDir.toPath, summaryFile = summaryFile, withInfra = withInfra)
      }
    }

    flattenTasks(subtasks)
  }
}